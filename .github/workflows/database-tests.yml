name: Database Tests

# TO ENABLE AUTOMATIC RUNS:
# 1. Configure the required secrets in GitHub Settings > Secrets and variables > Actions
# 2. Uncomment the automatic triggers below
# 3. Comment out or remove the workflow_dispatch line

# Required Secrets:
# - SUPABASE_ACCESS_TOKEN: Personal access token from Supabase dashboard (https://supabase.com/dashboard/account/tokens)
# - SUPABASE_PROJECT_REF: Your Supabase project reference ID (e.g., ltxqodqlexvojqqxquew)
# - SUPABASE_URL: Your Supabase project URL (e.g., https://xxx.supabase.co)
# - SUPABASE_ANON_KEY: Your Supabase anonymous/public API key

on:
  workflow_dispatch:  # Manual trigger only - uncomment automatic triggers when secrets are configured
  # Uncomment when ready:
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main ]

jobs:
  test-database:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1

    - name: Run Database Tests
      run: |
        supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        supabase db push
        supabase test db
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

    - name: Run Function Tests
      run: npm run test:functions
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
