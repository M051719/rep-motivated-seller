FRONT END
Schedule Regular Compliance Reviews:

Set up weekly or monthly reviews of your compliance audit results
Address any issues promptly to maintain compliance
Keep records of all compliance audits and remediation actions COMPLIANCE SUMMARY

Your **new TCPA-compliant SMS system**:

âœ… **Express Written Consent** - Double opt-in with verification
âœ… **Optional Service** - SMS not required to use your platform
âœ… **Clear Disclosures** - Full terms, frequency, and opt-out info
âœ… **Easy Opt-Out** - STOP keyword and web-based unsubscribe
âœ… **Record Keeping** - Complete audit trail with IP, timestamps
âœ… **Keyword Handling** - Automatic STOP, HELP, START processing
âœ… **Compliance Logging** - Every message tracked for legal compliance

I'll help you implement an Edge Function to handle SMS opt-in/opt-out functionality. First, let's check if we can gather any contextual information about your project.

I see that we're working with a foreclosure assistance system that needs SMS functionality.

Implementation Guide for SMS Opt-in/Opt-out System:
 Here's how it works:

1. Core Components
SMS Webhook Edge Function (sms-webhook):

Handles incoming SMS messages (STOP, HELP) for opt-outs
Processes Twilio delivery status callbacks
Maintains compliance with SMS regulations
SMS Sending Edge Function (send-sms):

Securely sends messages via Twilio
Authenticates requests
Verifies opt-in status before sending
Logs all message attempts
Client-Side Utility (not an Edge Function):

Captures and records user consent with IP address
Provides easy-to-use functions for sending SMS messages
Handles authentication with Supabase


2. Setup Instructions
Environment Variables
Add these to your project:

# Run this command after creating an .env file with these values:
supabase secrets set --env-file path/to/.env

# Required variables in your .env file:
TWILIO_ACCOUNT_SID=your_twilio_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_PHONE_NUMBER=your_twilio_phone_number

created an Edge Function to handle SMS webhook events from Twilio, which will allow users to opt-in/opt-out via text messages, and also process SMS status callbacks.

Create a compliant SMS system while waiting for Twilio approval:

// Add to your form component
const SMSOptIn = () => {
  return (
    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
      <label className="flex items-start space-x-3">
        <input
          type="checkbox"
          name="smsOptIn"
          className="mt-1"
        />
        <div className="text-sm">
          <p className="font-medium text-blue-900">
            ðŸ“± Get Urgent Foreclosure Updates via Text
          </p>
          <p className="text-blue-700 mt-1">
            By checking this box, you consent to receive text messages from RepMotivatedSeller.org
            about your foreclosure assistance request. Message frequency varies. Reply STOP to opt-out
            at any time. Standard message and data rates apply.
          </p>
          <p className="text-xs text-blue-600 mt-2">
            For help, reply HELP or call support. See our{' '}
            <a href="#privacy" className="underline">Privacy Policy</a> and{' '}
            <a href="#terms" className="underline">Terms of Service</a>.
          </p>
        </div>
      </label>
    </div>
  )
}





















Deployment Steps

Deploy the Edge Functions:[DONE]
supabase functions deploy sms-webhook
supabase functions deploy send-sms

Configure Twilio (when approved):

Set your Webhook URL to: https://ltxqodqlexvojqqxquew.supabase.co/functions/v1/sms-webhook/incoming
Set Status Callback URL to: https://ltxqodqlexvojqqxquew.supabase.co/functions/v1/sms-webhook/status

Add the client utility to your frontend project:

Place the code in: utils/sms-consent-helper.ts





Integration with Your Form
Update your form submission handler:
import { saveSMSConsent } from '../utils/sms-consent-helper';

// In your form submission handler:
const handleSubmit = async (event) => {
  event.preventDefault();

  // Your existing form submission logic...
  const { data: submission, error } = await supabase
    .from('foreclosure_submissions')
    .insert([formData])
    .select()
    .single();

  if (error) {
    console.error('Error submitting form:', error);
    return;
  }

  // Handle SMS consent
  const smsOptIn = event.target.smsOptIn.checked;
  const phone = formData.phone; // Get phone from your form

  if (smsOptIn && phone) {
    await saveSMSConsent(submission.id, phone, true);

    // Optional: Send welcome SMS
    const { success, error } = await sendSMS(
      submission.id,
      phone,
      "Thank you for signing up for foreclosure assistance updates. Reply HELP for help, STOP to unsubscribe."
    );

    if (error) {
      console.error('Error sending welcome SMS:', error);
    }
  }
};































3. Compliance Considerations
The implementation follows SMS compliance best practices:

Clear Consent: The opt-in checkbox provides clear disclosure
Record Keeping: Logs IP address and timestamp of consent
Opt-Out Mechanism: Supports standard STOP, HELP keywords
Frequency Disclosure: Mentions "Message frequency varies"
Message & Data Rates: Includes "Standard message and data rates apply"
Terms & Privacy: Links to policies
Help Instructions: Provides HELP keyword instructions


Integration with Your Form
Update your form submission handler:
import { saveSMSConsent, sendSMS } from '../utils/sms-consent-helper';

// In your form submission handler:
const handleSubmit = async (event) => {
  event.preventDefault();

  // Your existing form submission logic...
  const { data: submission, error } = await supabase
    .from('foreclosure_submissions')
    .insert([formData])
    .select()
    .single();

  if (error) {
    console.error('Error submitting form:', error);
    return;
  }

  // Handle SMS consent
  const smsOptIn = event.target.smsOptIn.checked;
  const phone = formData.phone; // Get phone from your form

  if (smsOptIn && phone) {
    await saveSMSConsent(submission.id, phone, true);

    // Optional: Send welcome SMS
    const { success, error } = await sendSMS(
      submission.id,
      phone,
      "Thank you for signing up for foreclosure assistance updates. Reply HELP for help, STOP to unsubscribe."
    );

    if (error) {
      console.error('Error sending welcome SMS:', error);
    }
  }
};




4. Testing
You can test the system:

Submit a form with the SMS opt-in checked
Use the Twilio test console to simulate incoming STOP/HELP messages
Check the sms_logs table to verify message status updates

Configure Twilio (when approved):

Set your Webhook URL to: https://ltxqodqlexvojqqxquew.supabase.co/functions/v1/sms-webhook/incoming

Set Status Callback URL to: https://ltxqodqlexvojqqxquew.supabase.co/functions/v1/sms-webhook/status
Add the client utility to your frontend project:

Create the file at: utils/sms-consent-helper.ts





the client-side utility that you'll need to use in your application:
// utils/sms-consent-helper.ts
// This is a client-side utility file - not an Edge Function

import { createClient } from '@supabase/supabase-js';

// Initialize Supabase client
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY as string;
const supabase = createClient(supabaseUrl, supabaseAnonKey);

// Get user's IP address via a third-party service (for consent logging)
export async function getUserIP(): Promise<string> {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;
  } catch (error) {
    console.error('Error fetching IP:', error);
    return 'unknown';
  }
}

// Save SMS consent during form submission
export async function saveSMSConsent(
  submissionId: string,
  phoneNumber: string,
  hasConsent: boolean
): Promise<boolean> {
  try {
    // Get user's IP for consent records (TCPA compliance)
    const ipAddress = await getUserIP();

    // Update the submission record with consent information
    const { error } = await supabase
      .from('foreclosure_submissions')
      .update({
        sms_opt_in: hasConsent,
        sms_consent_ip: ipAddress,
        sms_consent_timestamp: new Date().toISOString(),
      })
      .eq('id', submissionId);

    if (error) {
      console.error('Error saving SMS consent:', error);
      return false;
    }

    // If user consented, log the initial consent in sms_logs
    if (hasConsent) {
      const { error: logError } = await supabase
        .from('sms_logs')
        .insert({
          submission_id: submissionId,
          phone_number: phoneNumber,
          message_content: 'Initial SMS opt-in consent',
          status: 'consent_logged'
        });

      if (logError) {
        console.error('Error logging consent:', logError);
      }
    }

    return true;
  } catch (error) {
    console.error('Error in saveSMSConsent:', error);
    return false;
  }
}

// Send an SMS via the Edge Function
export async function sendSMS(
  submissionId: string,
  phoneNumber: string,
  message: string
): Promise<{ success: boolean; error?: string }> {
  try {
    // Get current user session for authentication
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      return {
        success: false,
        error: 'Authentication required'
      };
    }

    // Call the Edge Function to send the SMS
    const response = await fetch(`${supabaseUrl}/functions/v1/send-sms`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`
      },
      body: JSON.stringify({
        submissionId,
        phoneNumber,
        message
      })
    });

    const result = await response.json();

    if (!response.ok) {
      return {
        success: false,
        error: result.error || 'Failed to send SMS'
      };
    }

    return {
      success: true
    };
  } catch (error) {
    console.error('Error sending SMS:', error);
    return {
      success: false,
      error: error.message
    };
  }
}




5. Compliance Features
The implementation includes all required TCPA compliance features:

Clear consent capture
IP address and timestamp logging
Standard opt-out keywords (STOP, CANCEL, etc.)
Standard help keyword support
Proper opt-out record keeping